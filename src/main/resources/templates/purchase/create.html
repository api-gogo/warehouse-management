<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WMS - 발주서 생성</title>
    <!-- 폰트어썸 아이콘 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 변수 정의 */
        :root {
            /* 색상 */
            --color-primary: #3b82f6;
            --color-primary-hover: #2563eb;
            --color-secondary: #f3f4f6;
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;
            --color-info: #6366f1;

            /* 배경 */
            --bg-main: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-sidebar: #ffffff;
            --bg-card: #ffffff;
            --bg-header: #ffffff;

            /* 텍스트 */
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --text-muted: #9ca3af;
            --text-sidebar: #4b5563;
            --text-sidebar-active: #111827;

            /* 테두리 */
            --border-color: #e5e7eb;

            /* 그림자 */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);

            /* 크기 */
            --border-radius: 0.5rem;
        }

        /* 다크 모드 */
        body.dark-mode {
            --bg-main: #111827;
            --bg-secondary: #1f2937;
            --bg-sidebar: #1f2937;
            --bg-card: #1f2937;
            --bg-header: #1f2937;

            --text-primary: #f9fafb;
            --text-secondary: #e5e7eb;
            --text-muted: #9ca3af;
            --text-sidebar: #d1d5db;
            --text-sidebar-active: #f9fafb;

            --border-color: #374151;
        }

        /* 기본 스타일 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.5;
            transition: background-color 0.3s, color 0.3s;
        }

        a {
            text-decoration: none;
            color: inherit;
        }

        ul {
            list-style: none;
        }

        button {
            background: none;
            border: none;
            cursor: pointer;
            font-family: inherit;
            font-size: inherit;
            color: inherit;
        }

        /* 페이지 콘텐츠 영역 */
        .page-content {
            padding: 1.5rem;
            min-height: 100vh;
            background-color: var(--bg-secondary);
        }

        /* 카드 */
        .card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            margin-bottom: 1.5rem;
        }

        .card-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .card-description {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .card-content {
            padding: 1rem;
        }

        /* 버튼 */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 0.25rem;
            transition: all 0.2s;
            cursor: pointer;
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--color-primary-hover);
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .btn-outline:hover {
            background-color: var(--bg-secondary);
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        .btn-icon {
            padding: 0.25rem;
            width: 2rem;
            height: 2rem;
        }

        .btn i {
            margin-right: 0.5rem;
        }

        .btn-icon i {
            margin-right: 0;
        }

        /* 폼 요소 */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-control {
            width: 100%;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--bg-main);
            color: var(--text-primary);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin-right: -0.5rem;
            margin-left: -0.5rem;
        }

        .form-col {
            flex: 1;
            padding-right: 0.5rem;
            padding-left: 0.5rem;
            min-width: 200px;
        }

        /* 테이블 */
        .table-container {
            overflow-x: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .table th {
            font-weight: 500;
            color: var(--text-secondary);
            background-color: var(--bg-secondary);
            font-size: 0.875rem;
        }

        .table tr:last-child td {
            border-bottom: none;
        }

        .table td {
            font-size: 0.875rem;
        }

        .table .text-right {
            text-align: right;
        }

        /* 배지 */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.125rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 9999px;
            border: 1px solid transparent;
        }

        .badge-outline {
            border-color: var(--border-color);
        }

        .badge-success {
            background-color: rgba(16, 185, 129, 0.1);
            color: #065f46;
        }

        .badge-warning {
            background-color: rgba(245, 158, 11, 0.1);
            color: #92400e;
        }

        .badge-info {
            background-color: rgba(99, 102, 241, 0.1);
            color: #4f46e5;
        }

        .badge-danger {
            background-color: rgba(239, 68, 68, 0.1);
            color: #b91c1c;
        }

        /* 유틸리티 */
        .flex {
            display: flex;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .justify-end {
            justify-content: flex-end;
        }

        .space-x-2 > * + * {
            margin-left: 0.5rem;
        }

        .font-medium {
            font-weight: 500;
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }

        /* 발주 품목 추가 버튼 */
        .item-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }

        /* 아이템 삭제 버튼 */
        .btn-delete-item {
            color: var(--color-danger);
        }

        /* 요약 정보 */
        .summary-info {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .summary-label {
            font-weight: 500;
        }

        .summary-value {
            font-weight: 600;
        }

        .summary-total {
            font-size: 1.125rem;
            font-weight: 700;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border-color);
        }

        /* 반응형 */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            
            .form-col {
                width: 100%;
                margin-bottom: 1rem;
            }
        }

        @media (max-width: 576px) {
            .page-content {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
<!-- 페이지 콘텐츠 영역 - 발주서 생성 페이지 -->
<main class="page-content">
    <div class="flex items-center justify-between">
        <h1 class="page-title">신규 발주서 생성</h1>
        <div class="flex items-center space-x-2">
            <a th:href="@{/purchases}" class="btn btn-outline btn-sm">
                <i class="fas fa-arrow-left"></i>
                목록으로
            </a>
        </div>
    </div>

    <form th:action="@{/purchases/save}" method="post" id="purchaseForm" th:object="${purchaseForm}">
        <!-- 기본 정보 카드 -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">기본 정보</h2>
                <p class="card-description">발주서의 기본 정보를 입력하세요.</p>
            </div>
            <div class="card-content">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="userId" class="form-label">담당자</label>
                            <select id="userId" name="userId" class="form-control" required th:field="*{userId}">
                                <option value="">담당자 선택</option>
                                <option th:each="user : ${users}" th:value="${user.id}" th:text="${user.name}">김담당</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="supplierId" class="form-label">공급업체</label>
                            <select id="supplierId" name="supplierId" class="form-control" required th:field="*{supplierId}">
                                <option value="">공급업체 선택</option>
                                <option th:each="supplier : ${suppliers}" th:value="${supplier.id}" th:text="${supplier.name}">A 공급업체</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="purchaseDate" class="form-label">발주일</label>
                            <input type="date" id="purchaseDate" name="purchaseDate" class="form-control" required th:field="*{purchaseDate}">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="purchaseDueDate" class="form-label">납기일</label>
                            <input type="date" id="purchaseDueDate" name="purchaseDueDate" class="form-control" required th:field="*{purchaseDueDate}">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="notes" class="form-label">비고</label>
                    <textarea id="notes" name="notes" class="form-control" rows="3" th:field="*{notes}"></textarea>
                </div>
            </div>
        </div>

        <!-- 발주 품목 카드 -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">발주 품목</h2>
                <p class="card-description">발주할 품목을 추가하세요.</p>
            </div>
            <div class="card-content">
                <div id="purchaseItemsContainer">
                    <!-- 발주 품목 목록 테이블 -->
                    <div class="table-container">
                        <table class="table" id="purchaseItemsTable">
                            <thead>
                            <tr>
                                <th style="width: 30%;">상품</th>
                                <th>카테고리</th>
                                <th>수량</th>
                                <th>단가</th>
                                <th>합계</th>
                                <th>관리</th>
                            </tr>
                            </thead>
                            <tbody>
                                <tr th:each="item, itemStat : *{items}">
                                    <td>
                                        <select th:field="*{items[__${itemStat.index}__].productId}" class="form-control product-select" required onchange="updateProductInfo(this)">
                                            <option value="">상품 선택</option>
                                            <option th:each="product : ${products}"
                                                    th:value="${product.id}"
                                                    th:text="${product.name}"
                                                    th:data-category="${product.category}"
                                                    th:data-price="${product.price}">
                                                상품 A
                                            </option>
                                        </select>
                                    </td>
                                    <td>
                                        <input type="text" th:field="*{items[__${itemStat.index}__].category}" class="form-control category-input" readonly>
                                    </td>
                                    <td>
                                        <input type="number" th:field="*{items[__${itemStat.index}__].quantity}" class="form-control quantity-input" min="1" required onchange="updateTotal(this)">
                                    </td>
                                    <td>
                                        <input type="number" th:field="*{items[__${itemStat.index}__].price}" class="form-control price-input" min="0" required readonly>
                                    </td>
                                    <td>
                                        <input type="number" th:field="*{items[__${itemStat.index}__].total}" class="form-control total-input" readonly>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-outline btn-sm btn-delete-item" onclick="removeItem(this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                <!-- 품목이 없을 경우 표시할 행 -->
                                <tr id="noItemsRow" th:if="${#lists.isEmpty(purchaseForm.items)}">
                                    <td colspan="6" style="text-align: center; padding: 2rem;">추가된 발주 품목이 없습니다.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- 품목 추가 버튼 -->
                    <div class="item-actions">
                        <button type="button" class="btn btn-outline btn-sm" onclick="addItem()">
                            <i class="fas fa-plus"></i>
                            품목 추가
                        </button>
                    </div>

                    <!-- 주문 요약 정보 -->
                    <div class="summary-info">
                        <div class="summary-row">
                            <span class="summary-label">총 품목 수:</span>
                            <span class="summary-value" id="totalItems">0개</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">총 수량:</span>
                            <span class="summary-value" id="totalQuantity">0개</span>
                        </div>
                        <div class="summary-row summary-total">
                            <span class="summary-label">총 금액:</span>
                            <span class="summary-value" id="grandTotal">0원</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 버튼 영역 -->
        <div class="flex justify-end space-x-2" style="margin-top: 1rem;">
            <button type="button" class="btn btn-outline" onclick="location.href='/purchases'">
                <i class="fas fa-times"></i>
                취소
            </button>
            <button type="submit" class="btn btn-primary" id="submitBtn">
                <i class="fas fa-save"></i>
                발주서 생성
            </button>
        </div>
    </form>
</main>

<script>
    // 페이지 로드 시 초기화
    document.addEventListener('DOMContentLoaded', function() {
        // 오늘 날짜를 기본값으로 설정
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('purchaseDate').value = today;
        
        // 납기일은 일주일 후로 설정
        const dueDate = new Date();
        dueDate.setDate(dueDate.getDate() + 7);
        document.getElementById('purchaseDueDate').value = dueDate.toISOString().split('T')[0];
        
        // 기존 항목들의 합계 계산
        updateAllTotals();
        updateSummary();
    });

    // 품목 추가 함수
    function addItem() {
        // 테이블 참조
        const table = document.getElementById('purchaseItemsTable');
        const tbody = table.querySelector('tbody');
        
        // '품목 없음' 행 제거
        const noItemsRow = document.getElementById('noItemsRow');
        if (noItemsRow) {
            noItemsRow.remove();
        }
        
        // 새 행 인덱스 계산
        const rowIndex = tbody.rows.length;
        
        // 새 행 생성
        const newRow = tbody.insertRow();
        
        // 행 내용 추가
        newRow.innerHTML = `
            <td>
                <select name="items[${rowIndex}].productId" class="form-control product-select" required onchange="updateProductInfo(this)">
                    <option value="">상품 선택</option>
                    ${Array.from(document.querySelectorAll('#purchaseItemsTable select.product-select:first-of-type option')).map(opt => {
                        if(opt.value === '') return '<option value="">상품 선택</option>';
                        return `<option value="${opt.value}" data-category="${opt.dataset.category}" data-price="${opt.dataset.price}">${opt.text}</option>`;
                    }).join('')}
                </select>
            </td>
            <td>
                <input type="text" name="items[${rowIndex}].category" class="form-control category-input" readonly>
            </td>
            <td>
                <input type="number" name="items[${rowIndex}].quantity" class="form-control quantity-input" min="1" value="1" required onchange="updateTotal(this)">
            </td>
            <td>
                <input type="number" name="items[${rowIndex}].price" class="form-control price-input" min="0" value="0" required readonly>
            </td>
            <td>
                <input type="number" name="items[${rowIndex}].total" class="form-control total-input" value="0" readonly>
            </td>
            <td>
                <button type="button" class="btn btn-outline btn-sm btn-delete-item" onclick="removeItem(this)">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
    }

    // 품목 제거 함수
    function removeItem(button) {
        const row = button.closest('tr');
        row.remove();
        
        // 행이 모두 제거되었는지 확인
        const tbody = document.querySelector('#purchaseItemsTable tbody');
        if (tbody.rows.length === 0) {
            // '품목 없음' 행 추가
            const newRow = tbody.insertRow();
            newRow.id = 'noItemsRow';
            newRow.innerHTML = '<td colspan="6" style="text-align: center; padding: 2rem;">추가된 발주 품목이 없습니다.</td>';
        } else {
            // 행 인덱스 재설정
            renumberRows();
        }
        
        // 요약 정보 업데이트
        updateSummary();
    }

    // 행 번호 재설정 함수
    function renumberRows() {
        const rows = document.querySelectorAll('#purchaseItemsTable tbody tr');
        rows.forEach((row, index) => {
            const inputs = row.querySelectorAll('input, select');
            inputs.forEach(input => {
                const name = input.name;
                if (name) {
                    input.name = name.replace(/\[\d+\]/, `[${index}]`);
                }
            });
        });
    }

    // 상품 정보 업데이트 함수
    function updateProductInfo(select) {
        const row = select.closest('tr');
        const option = select.options[select.selectedIndex];
        
        // 카테고리와 가격 설정
        const categoryInput = row.querySelector('.category-input');
        const priceInput = row.querySelector('.price-input');
        
        if (option.value) {
            categoryInput.value = option.dataset.category || '';
            priceInput.value = option.dataset.price || 0;
        } else {
            categoryInput.value = '';
            priceInput.value = 0;
        }
        
        // 합계 업데이트
        updateTotal(row.querySelector('.quantity-input'));
    }

    // 합계 계산 함수
    function updateTotal(input) {
        const row = input.closest('tr');
        const quantity = parseInt(row.querySelector('.quantity-input').value) || 0;
        const price = parseFloat(row.querySelector('.price-input').value) || 0;
        const total = quantity * price;
        
        row.querySelector('.total-input').value = total;
        
        // 요약 정보 업데이트
        updateSummary();
    }

    // 모든 항목의 합계 업데이트
    function updateAllTotals() {
        const rows = document.querySelectorAll('#purchaseItemsTable tbody tr:not(#noItemsRow)');
        rows.forEach(row => {
            const quantityInput = row.querySelector('.quantity-input');
            if (quantityInput) {
                updateTotal(quantityInput);
            }
        });
    }

    // 요약 정보 업데이트 함수
    function updateSummary() {
        const rows = document.querySelectorAll('#purchaseItemsTable tbody tr:not(#noItemsRow)');
        let totalItems = rows.length;
        let totalQuantity = 0;
        let grandTotal = 0;
        
        rows.forEach(row => {
            const quantity = parseInt(row.querySelector('.quantity-input').value) || 0;
            const total = parseFloat(row.querySelector('.total-input').value) || 0;
            
            totalQuantity += quantity;
            grandTotal += total;
        });
        
        document.getElementById('totalItems').textContent = totalItems + '개';
        document.getElementById('totalQuantity').textContent = totalQuantity + '개';
        document.getElementById('grandTotal').textContent = grandTotal.toLocaleString() + '원';
    }

    // 폼 제출 전 유효성 검사
    document.getElementById('purchaseForm').addEventListener('submit', function(e) {
        const rows = document.querySelectorAll('#purchaseItemsTable tbody tr:not(#noItemsRow)');
        
        // 품목이 없는 경우
        if (rows.length === 0) {
            e.preventDefault();
            alert('최소 1개 이상의 발주 품목을 추가해주세요.');
            return false;
        }
        
        // 날짜 유효성 검사
        const purchaseDate = new Date(document.getElementById('purchaseDate').value);
        const purchaseDueDate = new Date(document.getElementById('purchaseDueDate').value);
        
        if (purchaseDueDate < purchaseDate) {
            e.preventDefault();
            alert('납기일은 발주일보다 이후여야 합니다.');
            return false;
        }
        
        return true;
    });
</script>
</body>
</html>