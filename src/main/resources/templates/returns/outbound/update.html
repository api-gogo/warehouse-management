<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default-layout}">
<head>
    <title>반품 정보 수정</title>
    <th:block layout:fragment="css">
        <style>
            .update-container {
                background-color: #fff;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
                margin-bottom: 20px;
            }
            .form-header {
                border-bottom: 1px solid #eee;
                padding-bottom: 15px;
                margin-bottom: 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .form-title {
                font-size: 1.5rem;
                font-weight: 600;
                margin: 0;
            }
            .form-status {
                padding: 5px 10px;
                border-radius: 4px;
                font-size: 0.9rem;
                font-weight: 600;
            }
            .status-waiting {
                background-color: #ffc107;
                color: #212529;
            }
            .status-approved {
                background-color: #28a745;
                color: white;
            }
            .status-rejected {
                background-color: #dc3545;
                color: white;
            }
            .status-completed {
                background-color: #17a2b8;
                color: white;
            }
            .form-row {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
                margin-bottom: 15px;
            }
            .form-group {
                margin-bottom: 15px;
            }
            .form-label {
                font-weight: 600;
                display: block;
                margin-bottom: 5px;
                color: #555;
            }
            .form-control {
                width: 100%;
                padding: 10px;
                border-radius: 4px;
                border: 1px solid #ced4da;
            }
            .form-select {
                width: 100%;
                padding: 10px;
                border-radius: 4px;
                border: 1px solid #ced4da;
            }
            .form-submit {
                margin-top: 20px;
                text-align: center;
            }
            .btn {
                padding: 10px 20px;
                border-radius: 4px;
                font-weight: 500;
                cursor: pointer;
                border: none;
            }
            .btn-primary {
                background-color: #007bff;
                color: white;
            }
            .btn-secondary {
                background-color: #6c757d;
                color: white;
                text-decoration: none;
                display: inline-block;
                margin-left: 10px;
            }
            .items-container {
                border: 1px solid #ddd;
                padding: 15px;
                border-radius: 8px;
                margin-top: 20px;
            }
            .item-row {
                display: grid;
                grid-template-columns: 2fr 1fr 2fr 1fr;
                gap: 10px;
                margin-bottom: 10px;
                align-items: center;
            }
            .btn-add-item {
                background-color: #28a745;
                color: white;
                padding: 5px 10px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 0.9rem;
            }
            .btn-remove-item {
                background-color: #dc3545;
                color: white;
                padding: 5px 10px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 0.9rem;
                width: 100%;
            }
            .required:after {
                content: " *";
                color: red;
            }
            .readonly-field {
                background-color: #f8f9fa;
                cursor: not-allowed;
            }
        </style>
    </th:block>
</head>
<body>
    <div layout:fragment="content">
        <div class="container">
            <div class="update-container">
                <div class="form-header">
                    <h2 class="form-title">반품 정보 수정</h2>
                    <span th:class="${'form-status ' + 
                                (ReturnShipmentDTO.returnShipmentStatus.name() == 'RETURN_WAITING' ? 'status-waiting' : 
                                (ReturnShipmentDTO.returnShipmentStatus.name() == 'RETURN_APPROVED' ? 'status-approved' : 
                                (ReturnShipmentDTO.returnShipmentStatus.name() == 'RETURN_REJECTED' ? 'status-rejected' : 'status-completed')))}"
                          th:text="${ReturnShipmentDTO.returnShipmentStatus.returnShipmentStatus}">
                        상태
                    </span>
                </div>
                
                <form th:action="@{/returns/outbound/update/{id}(id=${ReturnShipmentDTO.returnShipmentId})}" method="post">
                    <!-- 히든 필드 - 기존 ID 유지 -->
                    <input type="hidden" name="returnShipmentId" th:value="${ReturnShipmentDTO.returnShipmentId}">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="storeId" class="form-label required">매장 선택</label>
                            <select id="storeId" name="storeId" class="form-select" required>
                                <option value="">매장을 선택하세요</option>
                                <option th:each="store : ${stores}" 
                                        th:value="${store.storeId}" 
                                        th:text="${store.storeName + ' (' + store.storeId + ')'}"
                                        th:selected="${store.storeId == ReturnShipmentDTO.storeId}">
                                    더현대 서울점 (100)
                                </option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="userId" class="form-label required">담당자 선택</label>
                            <select id="userId" name="userId" class="form-select" required>
                                <option value="">담당자를 선택하세요</option>
                                <option th:each="user : ${users}" 
                                        th:value="${user.userId}" 
                                        th:text="${user.userName + ' (' + user.userPart + ')'}"
                                        th:selected="${user.userId == ReturnShipmentDTO.userId}">
                                    홍길동 (영업부)
                                </option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="shipmentId" class="form-label required">출고 ID</label>
                        <input type="number" id="shipmentId" name="shipmentId" class="form-control" 
                               th:value="${ReturnShipmentDTO.shipmentId}" required>
                    </div>
                    
                    <!-- 반품 상태 필드 -->
                    <div class="form-group">
                        <label for="returnShipmentStatus" class="form-label required">반품 상태</label>
                        <select id="returnShipmentStatus" name="returnShipmentStatus" class="form-select" required>
                            <option value="RETURN_WAITING" th:selected="${ReturnShipmentDTO.returnShipmentStatus.name() == 'RETURN_WAITING'}">반품 대기</option>
                            <option value="RETURN_APPROVED" th:selected="${ReturnShipmentDTO.returnShipmentStatus.name() == 'RETURN_APPROVED'}">반품 승인</option>
                            <option value="RETURN_REJECTED" th:selected="${ReturnShipmentDTO.returnShipmentStatus.name() == 'RETURN_REJECTED'}">반품 거절</option>
                            <option value="RETURN_COMPLETED" th:selected="${ReturnShipmentDTO.returnShipmentStatus.name() == 'RETURN_COMPLETED'}">반품 완료</option>
                        </select>
                    </div>
                    
                    <!-- 등록일 표시 (읽기 전용) -->
                    <div class="form-group">
                        <label class="form-label">등록일</label>
                        <input type="text" class="form-control readonly-field" 
                               th:value="${#temporals.format(ReturnShipmentDTO.returnShipmentCreatedAt, 'yyyy-MM-dd HH:mm')}" 
                               readonly>
                    </div>
                    
                    <!-- 반품 항목 입력 섹션 -->
                    <div class="items-container">
                        <h3>반품 항목</h3>
                        <p class="text-muted">반품할 항목의 정보를 수정하세요. 항목 추가 버튼을 클릭하여 여러 항목을 등록할 수 있습니다.</p>
                        
                        <div id="items-wrapper">
                            <!-- 기존 항목들 표시 -->
                            <div th:if="${ReturnShipmentDTO.lotNumber != null and !ReturnShipmentDTO.lotNumber.empty}"
                                 th:each="lot, idx : ${ReturnShipmentDTO.lotNumber}" class="item-row">
                                <div class="form-group">
                                    <label class="form-label required">로트 번호</label>
                                    <input type="text" name="lotNumber" class="form-control" 
                                           th:value="${lot}" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label required">수량</label>
                                    <input type="number" name="returnShipmentQuantity" class="form-control" min="1" 
                                           th:value="${ReturnShipmentDTO.returnShipmentQuantity != null and ReturnShipmentDTO.returnShipmentQuantity.size() > idx.index ? ReturnShipmentDTO.returnShipmentQuantity[idx.index] : 1}" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label required">반품 사유</label>
                                    <select name="returnShipmentContent" class="form-select" required>
                                        <option value="EXPIRED" 
                                                th:selected="${ReturnShipmentDTO.returnShipmentContent != null and ReturnShipmentDTO.returnShipmentContent.size() > idx.index and ReturnShipmentDTO.returnShipmentContent[idx.index].name() == 'EXPIRED'}">
                                            유통기한 만료
                                        </option>
                                        <option value="DAMAGED_OR_DEFECTIVE" 
                                                th:selected="${ReturnShipmentDTO.returnShipmentContent != null and ReturnShipmentDTO.returnShipmentContent.size() > idx.index and ReturnShipmentDTO.returnShipmentContent[idx.index].name() == 'DAMAGED_OR_DEFECTIVE'}">
                                            손상 또는 결함
                                        </option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="button" class="btn-remove-item" onclick="removeItem(this)" 
                                            th:disabled="${ReturnShipmentDTO.lotNumber.size() <= 1}">삭제</button>
                                </div>
                            </div>
                            
                            <!-- 기존 항목이 없는 경우 기본 템플릿 -->
                            <div th:if="${ReturnShipmentDTO.lotNumber == null or ReturnShipmentDTO.lotNumber.empty}" class="item-row">
                                <div class="form-group">
                                    <label class="form-label required">로트 번호</label>
                                    <input type="text" name="lotNumber" class="form-control" placeholder="로트 번호 입력" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label required">수량</label>
                                    <input type="number" name="returnShipmentQuantity" class="form-control" min="1" value="1" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label required">반품 사유</label>
                                    <select name="returnShipmentContent" class="form-select" required>
                                        <option value="EXPIRED">유통기한 만료</option>
                                        <option value="DAMAGED_OR_DEFECTIVE">손상 또는 결함</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="button" class="btn-remove-item" onclick="removeItem(this)" disabled>삭제</button>
                                </div>
                            </div>
                        </div>
                        
                        <button type="button" class="btn-add-item" onclick="addItem()">
                            <i class="fas fa-plus"></i> 항목 추가
                        </button>
                    </div>
                    
                    <div class="form-submit">
                        <button type="submit" class="btn btn-primary">변경사항 저장</button>
                        <a th:href="@{/returns/outbound/detail/{id}(id=${ReturnShipmentDTO.returnShipmentId})}" class="btn btn-secondary">취소</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <th:block layout:fragment="scripts">
        <script>
            // 항목 추가 함수
            function addItem() {
                const wrapper = document.getElementById('items-wrapper');
                const rows = wrapper.querySelectorAll('.item-row');
                
                // 첫 번째 항목 행 복제
                const newRow = rows[0].cloneNode(true);
                
                // 입력 필드 초기화
                const inputs = newRow.querySelectorAll('input, select');
                inputs.forEach(input => {
                    if (input.type === 'number' && input.name === 'returnShipmentQuantity') {
                        input.value = 1;
                    } else if (input.type === 'text') {
                        input.value = '';
                    }
                });
                
                // 삭제 버튼 활성화
                const removeBtn = newRow.querySelector('.btn-remove-item');
                removeBtn.disabled = false;
                
                // 항목 행 추가
                wrapper.appendChild(newRow);
                
                // 첫 번째 행의 삭제 버튼도 활성화 (2개 이상일 경우)
                if (rows.length === 1) {
                    rows[0].querySelector('.btn-remove-item').disabled = false;
                }
            }
            
            // 항목 삭제 함수
            function removeItem(button) {
                const wrapper = document.getElementById('items-wrapper');
                const rows = wrapper.querySelectorAll('.item-row');
                
                // 최소한 하나의 항목은 유지
                if (rows.length > 1) {
                    const row = button.closest('.item-row');
                    row.remove();
                    
                    // 만약 항목이 하나만 남았다면 삭제 버튼 비활성화
                    const remainingRows = wrapper.querySelectorAll('.item-row');
                    if (remainingRows.length === 1) {
                        remainingRows[0].querySelector('.btn-remove-item').disabled = true;
                    }
                }
            }
        </script>
    </th:block>
</body>
</html>