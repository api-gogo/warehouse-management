<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" layout:decorate="~{layouts/default-layout}"
        xmlns:layout="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>출고 관리</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <meta name="_csrf" th:content="${_csrf.token}" th:if="${_csrf != null}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}" th:if="${_csrf != null}"/>
    <!-- 페이지별 CSS -->
    <th:block layout:fragment="css">
        <link rel="stylesheet" href="/css/예시.css">
    </th:block>
    <style>
        .dark-mode h2 {
            color: snow;
        }
        .form-label {
            color: #1a1a1a;
        }
        .page-link{

        }
        body {
            background-color: #f8f9fa;
        }
        .container {
            margin-top: 30px;
            margin-bottom: 30px;
        }
        .table th, .table td {
            vertical-align: middle;
        }
        .badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .badge-waiting {
            background-color: #ffeeba;
            color: #856404;
        }
        .badge-inspecting {
            background-color: #b8daff;
            color: #004085;
        }
        .badge-completed {
            background-color: #c3e6cb;
            color: #155724;
        }
        .badge-delayed {
            background-color: #f5c6cb;
            color: #721c24;
        }
        .badge-cancelled {
            background-color: #d6d8db;
            color: #1b1e21;
        }
        .search-section {
            background-color: #ffffff;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .error-message {
            color: #dc3545;
            font-size: 0.9rem;
            margin-top: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
<!-- 페이지 콘텐츠 -->
<th:block layout:fragment="content" th:with="activeMenu='예시'">
    <div class="예시-container">
        <!-- 페이지 내용 -->
        <div class="container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>출고 관리</h2>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addShipmentModal">
                    + 신규 출고 등록
                </button>
            </div>

            <!-- 에러 메시지 표시 -->
            <div th:if="${error != null}" class="error-message">
                <span th:text="${error}"></span>
            </div>

            <!-- 성공 메시지 표시 -->
            <div th:if="${message != null}" class="alert alert-success" role="alert">
                <span th:text="${message}"></span>
            </div>

            <!-- 검색 및 필터링 영역 -->
            <div class="search-section">
                <form th:action="@{/shipments}" method="get" class="row g-3">
                    <div class="col-md-3">
                        <label for="status" class="form-label">상태</label>
                        <select class="form-select" id="status" name="status">
                            <option value="">전체</option>
                            <option value="출고대기" th:selected="${param.status == '출고대기'}">출고대기</option>
                            <option value="검수중" th:selected="${param.status == '검수중'}">검수중</option>
                            <option value="출고완료" th:selected="${param.status == '출고완료'}">출고완료</option>
                            <option value="출고지연" th:selected="${param.status == '출고지연'}">출고지연</option>
                            <option value="출고취소" th:selected="${param.status == '출고취소'}">출고취소</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="searchTerm" class="form-label">검색어</label>
                        <input type="text" class="form-control" id="searchTerm" name="searchTerm" th:value="${param.searchTerm != null ? param.searchTerm : ''}" placeholder="출고번호, 수주ID 검색">
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary btn-sm me-2">검색</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="location.href='/shipments'">초기화</button>
                    </div>
                </form>
            </div>

            <!-- 출고 목록 테이블 -->
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-light">
                    <tr>
                        <th>출고번호</th>
                        <th>수주 ID</th>
                        <th>담당자 ID</th>
                        <th>출고일</th>
                        <th>상태</th>
                        <th>등록일</th>
                        <th>수정일</th>
                        <th>액션</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:if="${shipments == null || #lists.isEmpty(shipments)}">
                        <td colspan="8" class="text-center">등록된 출고 정보가 없습니다.</td>
                    </tr>
                    <tr th:each="shipment : ${shipments}">
                        <td th:text="${shipment.shipmentId != null ? shipment.shipmentId : '-'}">-</td>
                        <td th:text="${shipment.saleId != null ? shipment.saleId : '-'}">-</td>
                        <td th:text="${shipment.userId != null ? shipment.userId : '-'}">-</td>
                        <td th:text="${shipment.shipmentDate != null ? #temporals.format(shipment.shipmentDate, 'yyyy-MM-dd HH:mm') : '-'}">-</td>
                        <td>
                            <span th:class="${'badge ' +
                                (shipment.shipmentStatus == '출고대기' ? 'badge-waiting' :
                                (shipment.shipmentStatus == '검수중' ? 'badge-inspecting' :
                                (shipment.shipmentStatus == '출고완료' ? 'badge-completed' :
                                (shipment.shipmentStatus == '출고지연' ? 'badge-delayed' :
                                (shipment.shipmentStatus == '출고취소' ? 'badge-cancelled' : '')))))}"
                                  th:text="${shipment.shipmentStatus != null ? shipment.shipmentStatus : '-'}">-</span>
                        </td>
                        <td th:text="${shipment.createdAt != null ? #temporals.format(shipment.createdAt, 'yyyy-MM-dd') : '-'}">-</td>
                        <td th:text="${shipment.updatedAt != null ? #temporals.format(shipment.updatedAt, 'yyyy-MM-dd') : '-'}">-</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a class="btn btn-outline-primary btn-sm" th:href="@{/shipments/{id}(id=${shipment.shipmentId})}">상세</a>
                                <button class="btn btn-outline-secondary btn-sm edit-btn"
                                        th:if="${shipment.shipmentStatus != '출고완료' && shipment.shipmentStatus != '출고취소'}"
                                        data-bs-toggle="modal" data-bs-target="#editShipmentModal"
                                        th:attr="data-id=${shipment.shipmentId},
                                                data-sale-id=${shipment.saleId},
                                                data-user-id=${shipment.userId},
                                                data-shipment-date=${shipment.shipmentDate != null ? #temporals.format(shipment.shipmentDate, 'yyyy-MM-dd''T''HH:mm') : ''},
                                                data-shipment-status=${shipment.shipmentStatus},
                                                data-shipment-reason=${shipment.shipmentReason}">
                                    수정
                                </button>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- 페이지네이션 -->
            <nav th:if="${totalPages != null && totalPages > 0}">
                <ul class="pagination justify-content-center">
                    <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                        <a class="page-link" th:href="@{${'/shipments'}(page=0, size=${size != null ? size : 10}, status=${param.status}, searchTerm=${param.searchTerm})}">처음</a>
                    </li>
                    <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                        <a class="page-link" th:href="@{${'/shipments'}(page=${currentPage != null ? currentPage - 1 : 0}, size=${size != null ? size : 10}, status=${param.status}, searchTerm=${param.searchTerm})}">이전</a>
                    </li>
                    <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                        th:if="${i >= (currentPage != null ? currentPage - 2 : 0) and i <= (currentPage != null ? currentPage + 2 : 2)}"
                        th:classappend="${i == currentPage} ? 'active'">
                        <a class="page-link" th:href="@{${'/shipments'}(page=${i}, size=${size != null ? size : 10}, status=${param.status}, searchTerm=${param.searchTerm})}" th:text="${i + 1}">1</a>
                    </li>
                    <li class="page-item" th:classappend="${currentPage != null && currentPage + 1 >= totalPages} ? 'disabled'">
                        <a class="page-link" th:href="@{${'/shipments'}(page=${currentPage != null ? currentPage + 1 : 1}, size=${size != null ? size : 10}, status=${param.status}, searchTerm=${param.searchTerm})}">다음</a>
                    </li>
                    <li class="page-item" th:classappend="${currentPage != null && currentPage + 1 >= totalPages} ? 'disabled'">
                        <a class="page-link" th:href="@{${'/shipments'}(page=${totalPages - 1}, size=${size != null ? size : 10}, status=${param.status}, searchTerm=${param.searchTerm})}">마지막</a>
                    </li>
                </ul>
            </nav>
        </div>

        <!-- 신규 출고 등록 모달 -->
        <div class="modal fade" id="addShipmentModal" tabindex="-1" aria-labelledby="addShipmentModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addShipmentModalLabel">신규 출고 등록</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form id="addShipmentForm" th:action="@{/shipments}" method="post">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" th:if="${_csrf != null}"/>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="saleId" class="form-label">수주 ID</label>
                                <input type="number" class="form-control" id="saleId" name="saleId" required>
                            </div>
                            <div class="mb-3">
                                <label for="userId" class="form-label">담당자 ID</label>
                                <input type="number" class="form-control" id="userId" name="userId" min="1" max="2147483647" required oninput="validateUserId(this)">
                                <div id="userIdError" class="invalid-feedback">
                                    담당자 ID는 1부터 2147483647 사이의 값이어야 합니다.
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="shipmentDate" class="form-label">출고일</label>
                                <input type="datetime-local" class="form-control" id="shipmentDate" name="shipmentDate" required>
                            </div>
                            <div class="mb-3">
                                <label for="shipmentStatus" class="form-label">상태</label>
                                <select class="form-select" id="shipmentStatus" name="shipmentStatus" required>
                                    <option value="출고대기">출고대기</option>
                                    <option value="검수중">검수중</option>
                                    <option value="출고완료">출고완료</option>
                                    <option value="출고지연">출고지연</option>
                                    <option value="출고취소">출고취소</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="shipmentReason" class="form-label">사유 (선택사항)</label>
                                <textarea class="form-control" id="shipmentReason" name="shipmentReason" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">취소</button>
                            <button type="submit" class="btn btn-primary btn-sm">등록</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 출고 정보 수정 모달 -->
        <div class="modal fade" id="editShipmentModal" tabindex="-1" aria-labelledby="editShipmentModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editShipmentModalLabel">출고 정보 수정</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form id="editShipmentForm" method="post">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" th:if="${_csrf != null}"/>
                        <div class="modal-body">
                            <input type="hidden" id="editShipmentId" name="shipmentId">
                            <div class="mb-3">
                                <label for="editSaleId" class="form-label">수주 ID</label>
                                <input type="number" class="form-control" id="editSaleId" name="saleId" required>
                            </div>
                            <div class="mb-3">
                                <label for="editUserId" class="form-label">담당자 ID</label>
                                <input type="number" class="form-control" id="editUserId" name="userId" min="1" max="2147483647" required oninput="validateUserId(this)">
                                <div id="editUserIdError" class="invalid-feedback">
                                    담당자 ID는 1부터 2147483647 사이의 값이어야 합니다.
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="editShipmentDate" class="form-label">출고일</label>
                                <input type="datetime-local" class="form-control" id="editShipmentDate" name="shipmentDate" required>
                            </div>
                            <div class="mb-3">
                                <label for="editShipmentStatus" class="form-label">상태</label>
                                <select class="form-select" id="editShipmentStatus" name="shipmentStatus" required>
                                    <option value="출고대기">출고대기</option>
                                    <option value="검수중">검수중</option>
                                    <option value="출고완료">출고완료</option>
                                    <option value="출고지연">출고지연</option>
                                    <option value="출고취소">출고취소</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="editShipmentReason" class="form-label">사유 (선택사항)</label>
                                <textarea class="form-control" id="editShipmentReason" name="shipmentReason" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">취소</button>
                            <button type="submit" class="btn btn-primary btn-sm">저장</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function validateUserId(input) {
            const value = parseInt(input.value);
            const max = 2147483647;
            const min = 1;

            if (value < min || value > max || isNaN(value)) {
                input.classList.add('is-invalid');
                input.classList.remove('is-valid');
            } else {
                input.classList.remove('is-invalid');
                input.classList.add('is-valid');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const shipmentDateStr = now.toISOString().slice(0, 16);
            document.getElementById('shipmentDate').value = shipmentDateStr;

            // 수정 버튼 클릭 시 모달 데이터 채우기
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    const saleId = this.getAttribute('data-sale-id');
                    const userId = this.getAttribute('data-user-id');
                    const shipmentDate = this.getAttribute('data-shipment-date');
                    const shipmentStatus = this.getAttribute('data-shipment-status');
                    const shipmentReason = this.getAttribute('data-shipment-reason');

                    document.getElementById('editShipmentId').value = id;
                    document.getElementById('editSaleId').value = saleId;
                    document.getElementById('editUserId').value = userId;
                    document.getElementById('editShipmentDate').value = shipmentDate;
                    document.getElementById('editShipmentStatus').value = shipmentStatus;
                    document.getElementById('editShipmentReason').value = shipmentReason || '';

                    // 폼의 action 속성 동적으로 설정
                    const form = document.getElementById('editShipmentForm');
                    form.action = '/shipments/update/' + id;
                });
            });

            // 폼 제출 시 클라이언트 측 유효성 검사
            document.getElementById('addShipmentForm').addEventListener('submit', function(event) {
                const userIdInput = document.getElementById('userId');
                validateUserId(userIdInput);
                if (userIdInput.classList.contains('is-invalid')) {
                    event.preventDefault();
                    alert('담당자 ID는 1부터 2147483647 사이의 값이어야 합니다.');
                }
            });

            document.getElementById('editShipmentForm').addEventListener('submit', function(event) {
                const editUserIdInput = document.getElementById('editUserId');
                validateUserId(editUserIdInput);
                if (editUserIdInput.classList.contains('is-invalid')) {
                    event.preventDefault();
                    alert('담당자 ID는 1부터 2147483647 사이의 값이어야 합니다.');
                } else {
                    const status = document.getElementById('editShipmentStatus').value;
                    if (status === '출고완료' || status === '출고취소') {
                        let message = status === '출고완료'
                            ? '출고완료시 더 이상 수정할 수 없습니다. 계속 진행하시겠습니까?'
                            : '출고취소시 더 이상 수정할 수 없습니다. 계속 진행하시겠습니까?';
                        if (!confirm(message)) {
                            event.preventDefault();
                        }
                    }
                }
            });
        });
    </script>
</th:block>

<!-- 페이지별 스크립트 -->
<th:block layout:fragment="scripts">
    <script>
        // 스크립트 내용

    </script>
</th:block>



</body>
</html>